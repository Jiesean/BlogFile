---
title: BLE 链路控制一
date: 2017-07-12 22:37:29
tags: [BLE,BT]
---


### 事件

在链路层，物理的信道被划分成时间的单元，这个时间单元叫做事件（Event）.

事件有两种，广播事件和连接事件，BLE的所有的操作都处于这两种事件当中。

### 广播事件

![](http://upload-images.jianshu.io/upload_images/1806858-7eb49624b3dbe916.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)
广播信道总共有三个，在每一次广播事件中，广播者会在这三个信道中分别发送一个相同的广播报文，以期待监听的设备可以在其中的一个信道接受到广播。

广播总共有4中类型： 通用的、定向的、不可连接的、可发现的，这些广播类型在广播报文的报头中有标记。

<!-- more -->

- ** 通用广播 ** 通用广播是用途最广泛的广播方式。这种类型既可以被扫描到，也可以接收到连接请求而建立连接。
- ** 定向广播 ** 用来在两个设备间快速建立连接用。这种报文包含了广播者的地址和接受者的地址，是定向的广播。定向广播不接受主动扫描，其报文中的净荷终不能含有附加数据，只有两个必需的地址。
- ** 不可连接广播 ** 这种广播只能用来广播自己的数据，不能被扫描或者连接。
- ** 可发现连接 ** 这种广播可以接受扫描并回应扫描请求，但是不能建立连接。

除了定向广播以外，其他的广播都是每个 20ms~10.28ms的间隔进行广播，主机可以控制该时间间隔，一般来说，每秒广播一次。
在固定的广播时间间隔后再加上0~10ms的随机延时，这样避免了如果两台设备的广播时间和时间间隔相同，两台设备就会一直冲突的问题。

对于定向广播以为有快速链接的要求，因此他必须每隔3.75ms重复一次广播，这样使得扫描者这需要扫描3.75ms就可以扫到设备。这样快的广播速率会导致在其广播的这一段时间间隔内其他设备无法进行广播，因此定向广播不能持续1.28s以上，到了1.28s，如果host没有停止，controller金辉主动停止。当达到1.28s之后依然没有链接上，则才用和其他广播类型一样采用更长的连接间隔进行广播。

### 建立连接
广播可以进行少量的信息的传输，而且广播是单向的，他无法检测到到底是谁接受了他的数据或者有设备在监听他的数据，因此这种形式的数据传输是不可靠的。想要进行可靠的数据交互必须通过连接才实现。


![建立连接的过程](http://upload-images.jianshu.io/upload_images/1806858-91f2c6140e1a1342.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

连接建立的过程，发起者需要发送一个连接请求，这个请求包含建立连接时的必要的信息，包括：
- 连接使用的接入地址
- CRC初始值
- 发送窗口的大小
- 发送窗口的偏移
- 连接间隔
- 从设备延迟
- 监控超时
- 自适应跳频信道图
- 跳频算法增量
- 休眠时钟精度

我们来看一个空口包的CONNECT_REQ包：

![image.png](http://upload-images.jianshu.io/upload_images/1806858-3d647329826b73dc.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)


** 接入地址 ** 由主设备提供用来区分每个连接，该地址是由主设备随机生成的；** CRC初始值 ** 的作用是区分那些产生了相同接入地址的主设备发送的数据包；

** 发送窗口 **和 ** 发送窗口的偏移 **是为了避免从设备一直监听主设备的数据包，只需要在规定的窗口时间内监听的设计，这样是为了最大程度的为从设备节约电量，发送窗口偏移主要是为了避开主设备忙碌的这段时间，避免从设备的空闲等待。

![](http://upload-images.jianshu.io/upload_images/1806858-9c6f3aa63ac58ef4.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)


发送窗口偏移是0~连接间隔之间的任意值，必须为1.25ms的整数倍；从设备在发送窗口偏移之后开始监听一个发送窗口的时间，期待主设备在这段时间内发送数据包，如果这段时间内没有收到主设备的数据包，从设备将等待一个连接间隔后继续。

关于连接过程，一个有意思的设定是，一旦发送了连接请求，主设备便认为自己处于连接状态，但是连接还没有被确认；从设备收到连接请求后，也认为自己处于连接之中，连接也没有被确认；只有当数据包确认后，连接才被视为正式确立，正式连接确认后，** 监控超时 **由连接间隔转变成6倍的连接间隔；

** 从设备延时 **是指从设备可以忽略的连接时间的数量，举例说明，如果从设备延迟是6 ,那么从设备可以忽略6个连接事件，但不得不监听第七次连接时间。

** 信道图 **则表示可以使用和不可以使用的信道的集合。
** 睡眠时间精度 ** 可以简单的理解为时钟的最大偏移量，例如我们同时规定00:00醒来，但是主设备可能有50ppm的偏移，而从设备有200ppm的偏移，左右偏移都有可能，因此最大的偏移是一个往左一个往右，这样偏移达到250ppm,也就意味着从设备要提前250us醒过来监听，以免错过主设备的数据包。


### 连接事件
连接建立后，主要进行上层数据的传输和链路层的连接管理。

一个连接事件，是指主设备和从设备完成一次数据交互的过程，一个连接事件的过程中，频率不发生变化，下一次连接事件时要进行跳频；

** 连接间隔 **是两个连接事件的时间间隔，可以是7.5ms~4s内的任意值，但必须是1.25ms的整数倍。

##### 数据发送
发送数据是连接时间中核心的智能，彼此设备的可靠交互也是依赖于数据发送的。

之前数据报文的时候讲过，数据报文的净荷是0~31字节不等。净荷为0时是一个空包，他们不包含任何的上层数据，但是仍然可以通过头部包含一定的信息，可以起到消息确认的作用。而且无论链路层加密与否，传给控制器的未加密数据包最多27个字节，这样做是为了降低链路层缓存的复杂度。

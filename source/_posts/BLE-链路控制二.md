---
title: BLE 链路控制二
date: 2017-07-12 20:06:00
tags: [BLE,BT]
---


接着上一篇的链路控制一 讲解了连接的建立，建立连接之后，就可以进行数据的传输。

### 连接管理

在连接的过程中同时还包括了对于连接的管理，包含七个连接控制的过程：
- 更新链接参数
- 改变自适应跳频信道图
- 加密链路
- 重加密链路
- 交换功能位
- 交换版本信息
- 终止链路

<!-- more -->

##### 更新链接参数

连接建立的时候，主设备通过发送连接请求发送了连接参数，但是隔一段时间后可能这些参数已不再适用，处于当前效率的目的，链接参数需要进行更新。

![](http://upload-images.jianshu.io/upload_images/1806858-64222fc946f9fc10.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

主设备通过发送链接请求更新这些参数，从设备只能接受这些参数，或者断开连接，这个更新数据包中包含了大量参数：

- 发送窗口的大小
- 发送窗口的偏移
- 连接间隔
- 从设备延迟
- 监控超时
- 瞬时

瞬时指的是连接更新的开始时刻，因为接收到连接更新请求时，可能还存在一些数据包未完成传输，必须为报文重传留下足够的时间，至少留出6次重传的机会。

如果到达了瞬时，数据包还未完成传输，则链路可能丢失；如果完成传输，就会执行新的连接参数。

##### 改变自适应跳频图谱

对于无线环境来说，好的信道和坏的信道是不断变化中的，因此必须使用信令进行更新新到图谱。

![](http://upload-images.jianshu.io/upload_images/1806858-3dbe7f7de67a27ab.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

从设备无法检测信道的好坏，也没有权利去改变信道图谱，这一切设计都是为了节约从设备的电量；

当主设备想要改变图谱，LL层会发送LL_CHANNEL_MAP_REQ向从设备发送图谱变化请求，该请求非常简单，包括：
- 瞬时
- 新的信道图谱

信道图谱是一个37位的字段，每一位代表一个信道，置1则表示该信道是好的，置0则表示该信道坏损；

##### 启动加密

只有没有加密的链路才能进行启动加密操作。

启动加密的过程需要双方提供的4字节组成的一个随机数， 双方提供的8字节提供的会话密钥，以及作为配对共享秘密的长期密钥（LTK）.


![](http://upload-images.jianshu.io/upload_images/1806858-fdfc2187cda164f7.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

主设备发送加密请求到从设备，从设备根据该请求里面的基本信息获得主设备的LTK, 然后从设备就会去查找自己保存的LTK，如果找到自己的LTK，则进行三次握手然后进行加密；

![](http://upload-images.jianshu.io/upload_images/1806858-3d7b80c7812b926b.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

如上图，如果host B 没有提供LTK 则会导致LL层拒绝加密请求。

当然如果从设备屏蔽了加密请求或者从设备不支持加密，则都会拒绝加密请求。

##### 重启加密

重启加密的目的是为了刷新会话密钥，一般是因为包计数器即将过期或者主机选择了新的链路密钥，并想要使用它来更新会话密钥。

因为BLE的连接很少持续很长时间，所以重启加密并没有太多的必要，也不常见。

![](http://upload-images.jianshu.io/upload_images/1806858-003f3f958453872e.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

重启加密的过程比启动加密多了暂停加密。

##### 版本交换

版本信息主要是为了方便调试的目的，可以通过链路层自动获取也可以通过主机请求获得该信息。

因为他不改变设备的行为，因此没必要每次建立连接的时候都交换这个信息，大多数设备只在10次连接请求一次版本信息。

![](http://upload-images.jianshu.io/upload_images/1806858-df4a51028ab6f6ab.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

版本信息包括：
- 版本号
- 公司标识符
- 子版本号

版本交换一旦完成，就不允许再执行该过程。

##### 功能交换

主设备通过功能请求报文询问从设备支持的功能，这种操作在每一个连接中只允许执行一次。
![](http://upload-images.jianshu.io/upload_images/1806858-877efde15fbedfd1.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

##### 终止连接

设备想要终止连接，需要发送一个终止连接的报文。

![](http://upload-images.jianshu.io/upload_images/1806858-13544dd9a8bd8c07.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

设备发送了终止指示的报文，如果没有收到确认，会认为过程超时，仍会断开连接，超时时间就是监控超时时间；如果设备收到对端的空包来响应该报文，则立即断开请求。

当然其他原因也可能导致连接的终止，包括监控超时，MIC失效。




